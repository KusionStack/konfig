#!/usr/bin/env kclvm

import os
import sys
import subprocess
from typing import Callable, List, Tuple
from pathlib import Path

PROJECT_FILE = 'project.yaml'
KCLMOD_FILE = 'kcl.mod'
HACK_DIR = 'hack'

# åˆå§‹åŒ–è‰²å½©
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
BOLD="\033[1m"
RESET="\033[m"


# ç¯å¢ƒå˜é‡
add_to_stage_after_compile = os.getenv("ADD_TO_STAGE_AFTER_COMPILE", "True") in ["true", "True", "1"]


class TaskResult:
    """ä»»åŠ¡æ‰§è¡Œç»“æœ"""
    success: bool
    suggest: str

    def __init__(self, success: bool, suggest: str):
        self.success = success
        self.suggest = suggest


class Task:
    """pre commit ä¸­æ‰§è¡Œçš„ä»»åŠ¡"""
    name: str
    work: Callable[[], TaskResult]

    def __init__(self, name, func):
        self.name = name
        self.work = func


# TODO: å·¥å…·æ–¹æ³•ï¼Œåç»­ç§»åˆ° lib ä¸­
def is_project_dir(p: Path) -> bool:
    """å½“å‰ç›®å½•æ˜¯å¦ä¸ºé¡¹ç›®ç›®å½•
    """
    project_file = p / PROJECT_FILE
    return project_file.is_file()


def get_project_root(p: Path) -> Path:
    """è·å– Project æ ¹ç›®å½•
    """
    while (str(p.resolve()) != "/"):
        if is_project_dir(p):
            return p
        p = p.resolve().parent
    return None


def get_konfig_root() -> Path:
    """è·å–å¤§åº“æ ¹ç›®å½•
    """
    p = Path(os.getcwd())
    while (str(p.resolve()) != "/"):
        if (p / KCLMOD_FILE).is_file() and (p / HACK_DIR).is_dir():
            return p
        p = p.resolve().parent
    return Path(os.getcwd())


def add_code_to_stage() -> Tuple[int, str]:
    """å°†ä¿®æ”¹åŠ å…¥åˆ°æš‚å­˜åŒº(stage)ï¼Œä½œä¸ºæœ¬æ¬¡æäº¤å†…å®¹"""
    konfig_root = get_konfig_root()
    # å°†ä¿®æ”¹åŠ å…¥åˆ°æš‚å­˜åŒº
    process = subprocess.run(["git", "add", "."],
                            capture_output=True,
                            cwd=konfig_root,
                            env=dict(os.environ))
    return (process.returncode, process.stderr)


# pre-commit ä»»åŠ¡
def pre_compile() -> TaskResult:
    """é¢„ç¼–è¯‘ä»»åŠ¡"""
    result = subprocess.run(['git', 'diff', '--cached', '--name-only'], stdout=subprocess.PIPE)
    changedFilesPaths = result.stdout.decode('utf-8').split("\n")

    # get changed projects
    changed_projects = set();
    konfig_root = get_konfig_root()
    for changeFilePath in changedFilesPaths:
        project_dir = get_project_root(konfig_root / changeFilePath)
        # not a project path
        if project_dir is None:
            continue
        if str(project_dir).startswith(os.path.join(konfig_root, "appops")):
            if not str(project_dir).startswith(os.path.join(konfig_root, "base")):
                # process /sigma/* (exclude /sigma/base)
                changed_projects.add(str(project_dir)[len(str(konfig_root))+1:])

    if len(changed_projects) > 0:
        compileRocketFile = os.path.join(konfig_root, "hack", "compile-rocket.py")
        command = "kclvm {} {}".format(compileRocketFile, " ".join(changed_projects))
        print(f"{GREEN}Running {command} ...{RESET}")
        # æ‰§è¡Œå‘½ä»¤
        process = subprocess.run(command.split(),
                                capture_output=True,
                                cwd=konfig_root,
                                env=dict(os.environ))
        # ä»»åŠ¡ç»“æŸï¼Œè¾“å‡ºæç¤ºä¿¡æ¯
        stdout, stderr = process.stdout, process.stderr
        if stdout.decode().strip() != "":
            print(stdout.decode().strip(), flush=True)
        if process.returncode == 0:
            # ç¼–è¯‘æˆåŠŸ
            if add_to_stage_after_compile:
                print(f"{GREEN}ğŸ•’ æ­£åœ¨å°†ç¼–è¯‘ç»“æœåŠ å…¥åˆ°æš‚å­˜åŒº(stage)ï¼Œä½œä¸ºæœ¬æ¬¡æäº¤å†…å®¹...{RESET}")
                return_code, err_msg = add_code_to_stage()
                if return_code == 0:
                    # ç¼–è¯‘ç»“æœæˆåŠŸæ·»åŠ åˆ°æœ¬åœ°æäº¤
                    return TaskResult(True, "")
                else:
                    # ç¼–è¯‘ç»“æœæ·»åŠ åˆ°æœ¬åœ°æäº¤å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
                    print(str(err_msg))
                    return TaskResult(True, "è¯·æ£€æŸ¥é¢„ç¼–è¯‘ç»“æœ(stdout.golden.yaml)æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œè¯·ç¡®è®¤ç¬¦åˆé¢„æœŸåå†æ¬¡æäº¤")
            else:
                return TaskResult(True, "è¯·æ£€æŸ¥é¢„ç¼–è¯‘ç»“æœ(stdout.golden.yaml)æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œè¯·ç¡®è®¤ç¬¦åˆé¢„æœŸåå†æ¬¡æäº¤")
        else:
            # ç¼–è¯‘å¤±è´¥
            print(stderr.decode().strip(), flush=True)
            return TaskResult(False, "è¯·æ ¹æ®é¢„ç¼–è¯‘è¾“å‡ºæ—¥å¿—ï¼Œæ’æŸ¥æœ¬æ¬¡å˜æ›´çš„ KCL é…ç½®é—®é¢˜")
    else:
        # æ— éœ€ç¼–è¯‘
        print(f"{GREEN}ğŸ’¡ æ²¡æœ‰é¡¹ç›®é…ç½®å‘ç”Ÿå˜åŒ–ï¼Œæ— éœ€é¢„ç¼–è¯‘{RESET}")
        return TaskResult(True, "")


# æ‰§è¡Œæ¡†æ¶
def run_tasks(tasks: List[Task]) -> List[TaskResult]:
    """è¿è¡Œ pre commit ä»»åŠ¡åˆ—è¡¨"""
    results = []
    for task in tasks:
        print(f"{GREEN}ğŸ•’ å¼€å§‹è‡ªåŠ¨æ‰§è¡Œ{task.name}...{RESET}")
        result = task.work()
        print(f"{GREEN}ğŸ’¡ {task.name}æ‰§è¡Œç»“æŸ{RESET}")
        results.append(result)
    return results


def main() -> int:
    try:
        print(f"{GREEN}{BOLD}------------- å¼€å§‹æ‰§è¡Œæäº¤å‰ç½®æ£€æŸ¥ ğŸš€ -------------{RESET}")

        # å‡†å¤‡ & æ‰§è¡Œ pre commit ä»»åŠ¡åˆ—è¡¨
        tasks = [Task("é¢„ç¼–è¯‘", pre_compile)]
        results = run_tasks(tasks)

        # è¾“å‡ºæ£€æŸ¥ç»“æœ
        print(f"\n{GREEN}{BOLD}------------- æ‰§è¡Œç»“æœ -------------{RESET}")
        for task, result in zip(tasks, results):
            resultInfo = f"{GREEN}{BOLD}æˆåŠŸ{RESET}" if result.success else f"{RED}{BOLD}å¤±è´¥{RESET}"
            print(f"{GREEN}{task.name}:\t{resultInfo}{RESET}")

        # è¾“å‡ºæ£€æŸ¥å»ºè®®
        print(f"\n{GREEN}{BOLD}------------- å»ºè®® -------------{RESET}")
        for task, result in zip(tasks, results):
            suggestInfo = "æ— " if result.suggest.strip() == "" else (f"{GREEN}{BOLD}{result.suggest}{RESET}" if result.success else f"{RED}{BOLD}{result.suggest}{RESET}")
            print(f"{GREEN}{task.name}:\t{suggestInfo}{RESET}")

        # è¿”å›é”™è¯¯ç 
        allSuccess = all([result.success for result in results])
        return 0 if allSuccess else 1
    except Exception as e:
        print(e)
        print(f"{RED}{BOLD}pre-commit ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ç»“æŸ âŒ{RESET}")
        return 1
    finally:
        commitInfo = "" if allSuccess else "ä¸­æ­¢"
        commitLogo = "âœ…" if allSuccess else "âŒ"
        print(f"{GREEN}{BOLD}\n------------- å‰ç½®æ£€æŸ¥å®Œæˆï¼Œå·²{commitInfo}æäº¤ {commitLogo} -------------{RESET}\n")


if __name__ == '__main__':
    sys.exit(main())